# Enterprise Data Sharing managed application

## Introduction

This part of the repository contains the code for the Enterprise Data Sharing managed application. A managed application is a collection of Azure resources that can be deployed to an Azure subscription either using the Azure Marketplace or the Service Catalog approach.
To learn more about managed applications in Azure, you can take a look [here](https://learn.microsoft.com/en-us/azure/azure-resource-manager/managed-applications/overview)

## Quickstart

### Deploy pre-requirements

- Create a file based on the provision.config.template.json and make sure you add the following information:
  
| Json Config Section | Field name | Description | Possible values |
| --------------------|------------|-------------|-----------------|
| Global | azureLocation | Azure Region Location | Fill your preferred Azure Location
| Global | subscriptionID | Azure Subscription| Fill your preferred Azure Subscription ID
| Definition | resourceGroupName | Resource group name where the managed application definition will be located | DataMarketPlace_Internal_AMA_Definition |
| Definition | notificationEndpointUri | WebHook endpoint to use to send the Managed App instances related events | E.g: <https://SOMEWHERE.m.pipedream.net> |
| Definition | devopsEntraGroupObjectId | Entra ID Group for DevOps operations | Do not fill. Will be automatically generated by the prerequisites.sh script|
| Definition | keyvaultUserGroupObjectId | Entra ID Group for KeyVault operations | Do not fill. Will be automatically generated by the prerequisites.sh script|
| Ama | resourceGroupName | Resource group name where the managed application will be located| | DataMarketPlace_Internal_AMA |
| Ama.Analytics | useExistingCoManagedResourceGroup | Resource group name for co-managed resources exists? | true or false |
| Ama.Analytics | existingCoManagedResourceGroupName | Resource group name for co-managed resources (provider and consumer) | E.g: DataMarketPlace_Internal_AMA_CoMng |
| Ama.Analytics | useExistingSynapse |  Existing Purview account name | true or false |
| Ama.Analytics | existingSynapseWorkspaceResourceId |
| Ama.Analytics | useExistingPurview |  | true or false |
| Ama.Analytics | purviewName | Existing Purview account name| If useExistingPurview=true, add manually the purviewName, else skip field |
| Ama.Analytics | purviewResourceId | Existing Purview account ID | If useExistingPurview=true, add manually the purviewResourceID, else skip field |
| Ama.Analytics | identity (objectId/clientId and clientSecret) |
| Ama.Analytics | synapseSqlAdminGroupObjectId | Entra ID Group for Synapse Admin Group | Do not fill. Will be automatically generated by the prerequisites.sh script |
| Ama | subOwner (objectId/clientId and clientSecret) | Identity used for the Analytics capacity | Do not fill. Will be automatically generated by the prerequisites.sh script |
| Ama | environment |  Environment | Testing or Production |
| Ama | managedResourceGroupName |  Resource group name for managed resources | DataMarketPlace_Internal_AMA_Mng |
| Ama | offerTier |  Tier offering | standard |
| Ama | crossTenant |  Data Sharing solution to work across tenants | tue or false |
| Ama | name |  Name of the Managed application | E.g: DataMarketPlace_Internal |
| Ama | tenantId |  Tenant ID | Fill the Tenant ID of the subscription |

The prerequisites.sh script is responsible for the automation of:

- 4 Resource Groups as defined in the config file (Definition RG, Managed App RG, Managed RG and Co-Manged RG)
- 3 Entra ID groups as defined in the config file and replace just-in-time created Entra IDs in the config file
- 2 Application Registrations in Entra ID: analytics-sp and subowner_sp replace just-in-time created Entra IDs in the config file
- Signed-in user will be added to the KeyVault Entra ID and DevOps Entra ID groups
- analytics-sp app registration will be added to the synapseSqlAdmin Entra ID Group
- subowner-sp app registration will be added to the synapseSqlAdmin Entra ID Group
- Reader RBAC role to analytics-sp
- Owner Subscription RBAC role to subowner-sp

To run the script, run the following commands:

```bash
cd 1-data-marketplace/scripts
bash prerequirements.sh
```

### Graph Permissions

Furthermore, the analytics-sp requires authorization for the specified Graph API application permissions. To accomplish this, assign the Global Administrator role to the sp_graph service principal created during the prerequirements.sh process within your Entra ID manually.

In order to run the automation for the Graph permissions follow the steps below:

1 - Navigate to [Scripts](/enterprise-data-sharing/1-data-marketplace/scripts)

2 - Run pip install -r requirements.txt
    OR
    conda env create -f requirementmsgraphpython.yml

3 - Run [add-graph-permissions.py](/enterprise-data-sharing/1-data-marketplace/scripts/add-graph-permissions.py).
    This script    will be responsible to add the following permissions to the sp_graph service principal:

      - Applications.Read.All
  
      - Group.Read.All

      - User.Read.All

      - GroupMember.Read.All

### Deploy the Managed Application

To help you deploy the managed application definition and instanciate from it, we are providing a shell script that will help you. The script is located in the `scripts` folder and is called [provision.sh](./scripts/provision.sh). The script will deploy the managed application definition and instanciate from it. The script will require you to provide some parameters in a json file of which you can find a template [here](./scripts/provision.config.template.json). You will need to rename the file to `provision.config.json` and provide values for the following parameters:

Once your `provision.config.json` is ready, you can run the script as follows:

```bash
bash provision.sh
```
